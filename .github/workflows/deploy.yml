      - name: Deploy via AWS SSM (RunShellScript)
        run: |
          set -euo pipefail

          COMMANDS_JSON=$(cat <<'JSON'
          {"commands":["cd ${{ secrets.APP_DIR }}","sudo docker compose -f ${{ secrets.COMPOSE_FILE }} up -d --build"]}
JSON
          )

          CMD_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy via GitHub Actions" \
            --parameters "$COMMANDS_JSON" \
            --region "${{ secrets.AWS_REGION }}" \
            --query "Command.CommandId" \
            --output text)

          echo "CommandId=$CMD_ID"

          aws ssm wait command-executed \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region "${{ secrets.AWS_REGION }}"

          aws ssm get-command-invocation \
            --command-id "$CMD_ID" \
            --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
            --region "${{ secrets.AWS_REGION }}" \
            --query "{Status:Status,Stdout:StandardOutputContent,Stderr:StandardErrorContent}" \
            --output json
